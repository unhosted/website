<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Official Handbook of the No Cookie Crew" />
    <title>Unhosted 7: Adding remote storage to unhosted web apps</title>
    <link rel="stylesheet" href="../hljs/default.min.css" />
    <link rel="hub" href="http://pubsubhubbub.appspot.com/"/>
    <link rel="updates alternate" type="application/atom+xml" href="../feed.atom" />
    <link rel="author" type="text/html" href="https://michielbdejong.com/"/>

    <script src="../hljs/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" href="../adventures.css" />
  </head>

  <body>
    <article>
      <header>
        <h1>Unhosted Adventures</h1>
        <h2>Official Handbook of the No Cookie Crew</h2>
      </header>
      <h2>Episode 7: Adding remote storage to unhosted web apps</h2>
      <h3>Apps storing user data on your personal server</h3>
      <p>So far our unhosted web apps have relied on the browser's "Save as..." dialog to save files.
        We have set up our own personal server, but have only used it to host a profile and to run
        <a href="https://github.com/sockethub/sockethub">Sockethub</a> so that we can relay outgoing messages
        through it, to the servers it federates with. This week we will have a look at
        <a href="http://remotestorage.io/">remotestorage</a>, a protocol for allowing unhosted web apps to use
        your personal server as cloud storage.</p>
      <p>The protocol by which a client interacts with a remotestorage server is describe in
        <a href="https://tools.ietf.org/id/draft-dejong-remotestorage-00.txt">draft-dejong-remotestorage-00</a>,
        an IETF Internet-Draft that is currently in version -00. At its core are the http protocol, TLS, and CORS headers.</p>
      <p>A remotestorage server allows you to store, retrieve, and remove documents in a directory structure,
        using http PUT, GET, and DELETE verbs, respectively. It will respond with CORS headers in the http response, so
        that your browser will not forbid your web app from making requests to the storage origin.</p>
      <p>As an app developer, you will not have to write these http requests yourself. You can use the
        <a href="http://remotestorage.io/integrate/">remoteStorage.js</a> library.</p>
      
      <h3>Reusing reusable user data</h3>
      <p>The remoteStorage.js library is divided up into modules, one for each type of data. Your app would typically only
        request access to one or two such modules (possibly read-only). The library then takes care of displaying a widget in the top right of
        the window, which will obtain access to the corresponding parts of the storage using OAuth2's Implicit Grant flow.</p>
      <p>The Implicit Grant flow is special in that there is no requirement for server-to-server communication, so it can
        be used by unhosted web apps, despite their lack of server backend.
        The OAuth "dance" consists of two redirects: to a dialog page hosted by the storage provider,
        and back to the URL of the unhosted web app. On the way back, the storage provider will add an access token to the URL fragment,
        so the part after the '#' sign. That means that the token is not even sent to the statics-server that happens to serve up the
        unhosted web app. Of course the app could contain code that does post the data there, but at least such token leaking would be
        detectable.</p>
      <p>By default, OAuth requires each relying party to register with each service provider, and the remotestorage spec states that
        servers "MAY require the user to register applications as OAuth clients
        before first use", but in practice most remotestorage servers allow their users full freedom in their choice of which apps to 
        connect with.</p>
      <p>As an app developer you don't have to worry about all the ins and outs of the OAuth dance that goes on when the user connects
        your app to their storage. You just use the methods that the modules expose.</p>
      <p>Since there are not yet a lot of modules, and those that exist don't have a lot of methods in them yet, you are likely to end up
        writing and contributing (parts of) modules yourself. Instructions for how to do this are all linked from
        <a href="http://remotestorage.io/">remotestorage.io</a>.</p>
        
      
      <h3>Cloud sync should be transparent</h3>
      <p>As an app developer, you only call methods that are exposed by the various remoteStorage.js modules. The app is not at all concerned
        with all the data synchronization that goes on between its instance of remoteStorage.js, other apps running on the same device, apps
        running on other devices, and the
        canonical copy of the data on the remotestorage server. All the sync machinery is "behind" each module, so to speak, and the module
        will inform the app when relevant data comes in.</p>
      <p>Since all data your app touches needs to be sent to the user's remotestorage server, and changes can also arrive from there without
        prior warning, we have so far found it easiest to develop apps using a variation on what emberjs calls "the V-model".</p>
      <p>Actions like mouse clicks and key strokes from the user are received by DOM elements in your app. Usually, this DOM element could 
        determine by itself how it should be updating its appearance in reaction to that. But in the V-model, these actions are only passed
        through.</p>
      <p>The DOM element would at first leave its own state unchanged, passing the action to the controller, so the javascript code that
        implements the business logic and determines what the result (in terms of data state) of the user action should be. This state change
        is then effectuated by calling a method in one of the remoteStorage modules. So far, nothing still has changed on the screen.</p>
      <p>If we were to completely follow the V-model, then the change would first move further down to the storage server, and then ripple
        all the way back up (in the shape of a letter V), until it reaches the actual DOM elements again, and updates their visual state.</p>
      <p>But we want our apps to be responsive, even under bad network connections. In any case, waiting an entire http round-trip time before
        giving the user feedback about an action would generally take too long, even when the network conditions are good.</p>
      <p>This is why remoteStorage modules receive change events about outgoing changes at the moment the change travels out over the wire,
        and not after the http request completes. We jokingly call this concept Asynchronous Synchronization: the app does not have to wait
        for synchronization to finish; synchronization with the server happens asynchronously, in the background.</p>
      
      <h3>Two easy ways to connect at runtime</h3>
      <p>We mentioned that the remotestorage spec uses OAuth to allow a remoteStorage.js module to get access, at runtime, to its designated
        part of the user's storage. To allow the remoteStorage.js library to make contact with the user's remotestorage server, the user inputs
        their remotestorage address into the widget at the top right of the page. A remotestorage address looks like an email address, in that
        it takes the form 'user@host'. But here of course 'host' is your remotestorage provider, not your email provider, and 'user' is whatever
        username you have at that provider.</p>
      <p>The protocol that is used to discover the connection details from this 'user@host' string is called webfinger. Luckily, webfinger
        supports CORS headers, so it can be queried from an unhosted web app without needing to go through a server for that.
        We actually successfully <a href="https://groups.google.com/forum/#!topic/webfinger/kfcVkqBX0tQ">campaigned</a>
        for that support last year once we realized how vital this is for unhosted
        web apps. It is very nice to see how the processes around open standards on the web actually allowed us to put this issue on the agenda in
        this way.</p>
      <p>So the way this looks to the user is like this:</p>
      <ul>
        <li>Click 'connect remotestorage'</li>
        <li>Type your 'user@host' remotestorage address</li>
        <li>Log in to your remotestorage provider (with Persona or otherwise)</li>
        <li>Review which modules the app requests</li>
        <li>If it looks OK, click 'Accept'</li>
        <li>Your data will start appearing in the app</li>
      </ul>
      <!-- screenshots of first 4 steps -->
      <p>Another way to connect an unhosted web app and a remotestorage account at runtime is if you have an app launch panel that is already
        linked to your remotestorage account. You will get this for instance when you install the
        <a href="https://github.com/michielbdejong/owncloud-owa">ownCloud app</a>. Apps will simply appear with their icons in the web interface
        of your storage server, and because you launch them from there, there is no need to explicitly type in your remotestorage address once
        the app opens.</p>
      <!-- screenshot of owa screen -->
      <h3>Featured apps</h3>
      <p>The remoteStorage.js library reached its first beta version (labeled 0.7.0) last week, and we have collected a number of
        <a href="https://unhosted.org/apps/">featured apps</a> that use this version of the library. So far, I am using the
        <a href="http://music.unhosted.5apps.com/">music</a>, <a href="http://editor.unhosted.5apps.com/">editor</a> and
        <a href="http://grouptabs.xmartin.5apps.com/">grouptabs</a> apps for my real music-listening, text-editing, and peer-to-peer bookkeeping
        needs, respectively.</p>
      <p>There is also a minimal writing app on there called <a href="http://litewrite.unhosted.5apps.com/">Litewrite</a>, a video-bookmarking
        app called <a href="http://vidmarks.silverbucket.5apps.com/">Vidmarks</a>,
        a generic <a href="http://remotestorage-browser.nilclass.5apps.com/">remotestorage browser</a>, and a
        <a href="http://social.unhosted.5apps.com/">number</a> of
        <a href="http://todo.unhosted.5apps.com/">demo</a>
        <a href="http://drinks.unhosted.5apps.com/">apps</a>. If you don't have a remotestorage account yet, you can get one at
        <a href="https://5apps.com/">5apps</a> or at <a href="https://heahdk.net/">heahdk</a>. For more options and more info
        about remtestorage in general, see <a href="http://remotestorage.io/">remotestorage.io</a>. Enjoy! :)
    </article>
	
    <div class="logo">
      <img src="/img/island-color.png" />
    </div>
    
    <nav>
      <div id="episodes">
        <h4>Episodes:</h4>
        <p>(loading index)</p>
      </div>
            
      <div>
        <h4>Follow:</h4> 
        <ul>
          <li style="list-style-image: url('/img/atom.gif')"><a target="_blank" href="../feed.atom">atom</a></li>
          <li style="list-style-image: url('/img/rss2.gif')"><a target="_blank" href="../feed.rss">rss</a></li>
          <li style="list-style-image: url('/img/facebook.gif')"><a target="_blank" href="https://www.facebook.com/unhostedwebapps">facebook</a></li>
          <li style="list-style-image: url('/img/twitter.png')"><a target="_blank" href="https://twitter.com/unhosted">twitter</a></li>
          <li style="list-style-image: url('/img/statusnet.png')"><a target="_blank" href="https://identi.ca/unhosted">identica</a></li>
          <li style="list-style-image: url('/img/diaspora.png')"><a target="_blank" href="https://joindiaspora.com/u/unhosted">diaspora</a></li>
          <li style="list-style-image: url('/img/mailinglist.jpg')"><a target="_blank" href="https://groups.google.com/forum/#!forum/unhosted">mailing list</a></li>
          <li style="list-style-image: url('/img/irc.png')"><a target="_blank" href="http://webchat.freenode.net/?channels=#unhosted">irc channel</a></li>
        </ul>
      </div>
      
      <div>
        <h4>Author:</h4>
        <div class="logo">
          <img src="/img/michiel.jpg" />
        </div>
        <p>
          <a href="https://michielbdejong.com/">Michiel B. de Jong</a>
        </p>
      </div>
      
      <div>      
        <h4>Location:</h4>
        <div class="logo">
          <img src="/img/hackerbeach.png">
        </div>
        <p>
          <a href="http://hackerbeach.org/">Hacker Beach</a>
        </p>
      </div>
      
      <div>
        <h4>Unho코콘12 unconference:</h4>
        <p>
          <a class="logo" href="http://2012.unhosted.org/">
            <img src="/img/2012.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Unho코콘13 unconference:</h4>
        <p>
          <a class="logo" href="http://2013.unhosted.org/">
            <img src="/img/2013.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Spin-off projects:</h4>
        <p>
          <a class="logo" href="http://remotestorage.io/">
            <img src="/img/remotestorage.png"/>
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://tos-dr.info/">
            <img src="/img/tosdr.png"/>
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://opentabs.net/">
            <img src="/img/opentabs.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Supporters:</h4>
        <p>
          <a class="logo" href="http://nlnet.nl/">
            <img src="/img/nlnet.gif" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://wauland.de/">
            <img src="/img/wau.png" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://www.gabrielweinberg.com/blog/2012/03/duckduckgo-foss-donations-2011.html">
            <img src="/img/duckduckgo.jpg" />
          </a>
          &nbsp;
        </p>

        <p>
          and <a href="/thankyou.html">many more</a>&hellip;
        </p>
      </div>
    </nav>
    
    <footer>
      <strong>You can follow</strong>
      <img src="/img/twitter.png" /><a target="_blank" href="https://twitter.com/unhosted">@unhosted</a>
      <strong>on twitter and in</strong>
      <a href="#">many other ways</a><strong>. So stay tuned! :)</strong>
      </strong>
    </footer>
  </body>
  <script src="../episodes.js"></script>
</html>
